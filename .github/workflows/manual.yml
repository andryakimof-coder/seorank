# .github/workflows/ci-cd.yml
name: Build & Deploy to Yandex MKS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
  YC_REGISTRY: cr.yandex/${{ secrets.YC_FOLDER_ID }}/seorank
  KUBE_NAMESPACE: seorank

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: üõéÔ∏è Checkout
        uses: actions/checkout@v4

      - name: üê≥ Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -n
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: üîë Authenticate with Yandex Cloud
        run: |
          # –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º–∏/–Ω–æ–≤—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏ yc
          yc config set folderid "$YC_FOLDER_ID" || yc config set folder-id "$YC_FOLDER_ID"
          yc config set cloudid "${{ secrets.YC_CLOUD_ID }}" || yc config set cloud-id "${{ secrets.YC_CLOUD_ID }}"
          yc iam create-token \
            --jwt \
            --service-account-id "${{ secrets.YC_SERVICE_ACCOUNT_ID }}"
