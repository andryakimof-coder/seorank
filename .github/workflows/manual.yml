# .github/workflows/ci-cd.yml
name: Build & Deploy to Yandex MKS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
  YC_REGISTRY: cr.yandex/${{ secrets.YC_FOLDER_ID }}/seorank
  KUBE_NAMESPACE: seorank

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v4

      - name: ğŸ³ Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -n
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: ğŸ”‘ Authenticate with Yandex Cloud
        run: |
          # Ğ¡Ğ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ ÑĞ¾ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¼Ğ¸/Ğ½Ğ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ²ĞµÑ€ÑĞ¸ÑĞ¼Ğ¸ yc
          yc config set folderid "$YC_FOLDER_ID" || yc config set folder-id "$YC_FOLDER_ID"
          yc config set cloudid "${{ secrets.YC_CLOUD_ID }}" || yc config set cloud-id "${{ secrets.YC_CLOUD_ID }}"
          yc iam create-token \
            --jwt \
            --service-account-id "${{ secrets.YC_SERVICE_ACCOUNT_ID }}" \
            --ttl 3600 > ~/.yc-token
          yc config set token "$(cat ~/.yc-token)" || yc config set iam-token "$(cat ~/.yc-token)"

      - name: ğŸ“¦ Build & Push Docker image
        run: |
          IMAGE_TAG=${{ github.sha }}
          yc container registry configure-docker
          docker build -t "$YC_REGISTRY:$IMAGE_TAG" .
          docker push "$YC_REGISTRY:$IMAGE_TAG"
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: ğŸ” Generate Kubernetes Secrets
        run: |
          mkdir -p k8s-generated
          cat <<EOF > k8s-generated/app-secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
  namespace: $KUBE_NAMESPACE
type: Opaque
stringData:
  SECRET_KEY: "${{ secrets.SECRET_KEY }}"
  YANDEX_API_KEY: "${{ secrets.YANDEX_API_KEY }}"
  YANDEX_FOLDER_ID: "${{ secrets.YANDEX_FOLDER_ID }}"
EOF

      - name: âœ¨ Deploy to Kubernetes
        run: |
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ID Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ğ° Ğ² ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğµ
          CLUSTER_ID=$(yc k8s cluster list --folder-id "$YC_FOLDER_ID" --format json | jq -r '.[0].id')
          if [ -z "$CLUSTER_ID" ] || [ "$CLUSTER_ID" = "null" ]; then
            echo "âŒ No Kubernetes cluster found in folder $YC_FOLDER_ID"
            exit 1
          fi
          yc k8s cluster get-credentials "$CLUSTER_ID" --external
          # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ€ĞµÑÑƒÑ€ÑÑ‹
          kubectl create namespace "$KUBE_NAMESPACE" --dry-run=client -o yaml | kubectl apply -f -
          kubectl apply -f k8s-generated/app-secrets.yaml
          kubectl apply -f k8s/ 2>/dev/null || echo "âš ï¸ k8s/ not found â€” skipping"

      - name: ğŸš€ Rollout Status
        if: success()
        run: |
          kubectl rollout status deployment/seorank-web -n "$KUBE_NAMESPACE" --timeout=300s || true
          kubectl rollout status deployment/seorank-celery -n "$KUBE_NAMESPACE" --timeout=120s || true
