# .github/workflows/ci-cd.yml
name: Build & Deploy to Yandex MKS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
  YC_REGISTRY: cr.yandex/${{ secrets.YC_FOLDER_ID }}/seorank
  KUBE_NAMESPACE: seorank

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Ğ´Ğ»Ñ yc iam create-token --jwt

    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v4

      - name: ğŸ³ Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -n
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: ğŸ”‘ Authenticate with Yandex Cloud
        run: |
          yc config set folder-id $YC_FOLDER_ID
          yc iam create-token \
            --jwt \
            --service-account-id ${{ secrets.YC_SERVICE_ACCOUNT_ID }} \
            --ttl 3600 > ~/.yc-token
          yc config set token "$(cat ~/.yc-token)"

      - name: ğŸ“¦ Build & Push Docker image
        run: |
          IMAGE_TAG=${{ github.sha }}
          yc container registry configure-docker
          docker build -t $YC_REGISTRY:$IMAGE_TAG .
          docker push $YC_REGISTRY:$IMAGE_TAG
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: ğŸ” Generate Kubernetes Secrets
        run: |
          mkdir -p k8s-generated
          cat <<EOF > k8s-generated/app-secrets.yaml
          apiVersion: v1
          kind: Secret
          meta
            name: app-secrets
            namespace: $KUBE_NAMESPACE
          type: Opaque
          stringData:
            SECRET_KEY: "${{ secrets.SECRET_KEY }}"
            YANDEX_API_KEY: "${{ secrets.YANDEX_API_KEY }}"
            YANDEX_FOLDER_ID: "${{ secrets.YANDEX_FOLDER_ID }}"
          EOF

      - name: âœ¨ Deploy to Kubernetes
        run: |
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ kubeconfig
          CLUSTER_ID=$(yc k8s cluster list --folder-id $YC_FOLDER_ID --format json | jq -r '.[0].id')
          yc k8s cluster get-credentials $CLUSTER_ID --external

          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ namespace Ğ¸ ÑĞµĞºÑ€ĞµÑ‚Ñ‹
          kubectl create namespace $KUBE_NAMESPACE --dry-run=client -o yaml | kubectl apply -f -
          kubectl apply -f k8s-generated/app-secrets.yaml

          # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ñ‹ (Ğ¸Ñ… Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹!)
          kubectl apply -f k8s/ 2>/dev/null || echo "âš ï¸ k8s/ not found yet â€” add manifests!"

      - name: ğŸš€ Rollout Status
        if: success()
        run: |
          kubectl rollout status deployment/seorank-web -n $KUBE_NAMESPACE --timeout=300s || true
          kubectl rollout status deployment/seorank-celery -n $KUBE_NAMESPACE --timeout=120s || true
